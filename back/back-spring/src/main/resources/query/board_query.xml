<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd"> 
	

<mapper namespace="com.ssafy.backspring.model.dao.BoardDao" >
	<resultMap type="post" id="postMap">
		<result property="post_no" column="post_no" />
		<result property="board_no" column="board_no" />
		<result property="user_no" column="user_no" />
		<result property="post_title" column="post_title" />
		<result property="post_content" column="post_content" />
		<result property="post_recommendation_num" column="post_recommendation_num" />
		<result property="post_views_num" column="post_views_num" />
		<result property="post_blamed" column="post_blamed" />
		<result property="post_regtime" column="post_regtime" />
		<result property="post_updatetime" column="post_updatetime" />

		<association property="post_user" javaType="user">
			<id property="user_no" column="user_no" />
			<result property="user_email" column="user_email" />
			<result property="user_name" column="user_name" />
			<result property="user_lastlogin" column="user_lastlogin" />
		</association>
	</resultMap>

	<resultMap id="bpMap" type="board">
		<result property="board_no" column="board_no"/>
		<result property="board_title" column="board_title"/>
		<result property="board_category" column="board_category"/>
		<collection property="board_postList" ofType="post" resultMap="postMap" />
	</resultMap>
 	<insert id="insert"		parameterType="board">
	 	INSERT INTO BOARD(
			board_title,
			board_category)
		VALUES(
			#{board_title:VARCHAR},
			#{board_category:VARCHAR}
		);
	</insert> 
	
   	<delete id="delete" 	parameterType="int">
	</delete>

   	<update id="update"		parameterType="board">
   	</update>

	<select id="search"		parameterType="int"  resultType="board">
		SELECT * FROM BOARD WHERE board_no = #{board_no:INTEGER} AND board_del_check = FALSE
	</select>
	<select id="searchAll"	resultType="board">
		SELECT * FROM BOARD WHERE board_del_check = FALSE
	</select>
	
	<select id="searchAllBoard" parameterType="hashmap" resultMap="bpMap">
		<![CDATA[
		SELECT
			RESULT.*
		FROM (SELECT 
			(CASE 
				WHEN @vpost_no = bpu.post_no
				THEN @rownum:=@rownum
				ELSE @rownum:=@rownum+1
			END) AS rnum,
			(@vpost_no:=bpu.post_no) vpost_no,
			bpu.*
			FROM
				(SELECT 
					b.board_no,
					b.board_title,
					b.board_category,
					p.post_no,
					p.user_no,
					u.user_name,
					p.post_title,
					p.post_content,
					p.post_recommendation_num,
					p.post_views_num,
					p.post_blamed,
					p.post_regtime, 
					p.post_updatetime
					FROM BOARD b
					LEFT JOIN POST p ON p.board_no = b.board_no AND p.post_del_check=FALSE
					LEFT JOIN USER u ON p.user_no = u.user_no AND u.user_del_check=FALSE
					WHERE b.board_del_check=FALSE) as bpu, 
				(SELECT @vpost_no:='', @rownum:=0 FROM DUAL) as n
			) AS RESULT
		WHERE RESULT.rnum > #{startPage} AND RESULT.rnum <= #{endPage}]]>
	</select>
	<select id="searchTargetBoard" parameterType="hashmap" resultMap="bpMap">
		<![CDATA[
		SELECT
			RESULT.*
		FROM (SELECT 
			(CASE 
				WHEN @vpost_no = bpu.post_no
				THEN @rownum:=@rownum
				ELSE @rownum:=@rownum+1
			END) AS rnum,
			(@vpost_no:=bpu.post_no) vpost_no,
			bpu.*
			FROM
				(SELECT 
					b.board_no,
					b.board_title,
					b.board_category,
					p.post_no,
					p.user_no,
					u.user_name,
					p.post_title,
					p.post_content,
					p.post_recommendation_num,
					p.post_views_num,
					p.post_blamed,
					p.post_regtime, 
					p.post_updatetime
					FROM BOARD b
					LEFT JOIN POST p ON p.board_no = b.board_no AND p.post_del_check=FALSE
					LEFT JOIN USER u ON p.user_no = u.user_no AND u.user_del_check=FALSE
					WHERE b.board_del_check=FALSE AND b.board_no =#{target_no}) as bpu, 
				(SELECT @vpost_no:='', @rownum:=0 FROM DUAL) as n
			) AS RESULT
		WHERE RESULT.rnum > #{startPage} AND RESULT.rnum <= #{endPage}]]>
	</select>
</mapper>

